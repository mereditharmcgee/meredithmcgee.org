---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';

const portfolioItems = await getCollection('portfolio');
const sortedItems = portfolioItems.sort((a, b) => a.data.order - b.data.order);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Portfolio | ${SITE_TITLE}`} description="Explore Meredith McGee's portfolio of public health work including grant writing, research, program evaluation, and community impact projects." />
	</head>
	<body>
		<Header />

		<!-- Hero Section -->
		<section class="portfolio-hero bg-dark bg-pattern">
			<div class="container">
				<h1>Portfolio</h1>
				<p class="hero-intro">
					A selection of work spanning grant development, public health research, program evaluation, and community impact. Hover to preview, click to explore.
				</p>
			</div>
		</section>

		<!-- Filter Bar -->
		<section class="filter-section bg-light">
			<div class="container">
				<div class="filter-bar">
					<button class="filter-btn active" data-filter="all">All Work</button>
					<button class="filter-btn" data-filter="lgbtq">LGBTQ+ Health</button>
					<button class="filter-btn" data-filter="cannabis">Cannabis Policy</button>
					<button class="filter-btn" data-filter="development">Development</button>
					<button class="filter-btn" data-filter="research">Research</button>
					<button class="filter-btn" data-filter="communications">Communications</button>
				</div>
			</div>
		</section>

		<!-- Portfolio Grid -->
		<section class="portfolio-section bg-light">
			<div class="container">
				<div class="portfolio-grid">
					{sortedItems.map((item, index) => (
						<a href={`/portfolio/${item.slug}`}
						   class={`flip-card ${item.data.size}`}
						   style={`--delay: ${index * 0.1}s`}
						   data-tags={item.data.tags.join(',').toLowerCase()}
						   data-category={item.data.category.toLowerCase()}>
							<div class="flip-card-inner">
								<div class="flip-card-front">
									{item.data.video ? (
										<div class="card-video">
											<video autoplay loop muted playsinline>
												<source src={item.data.video} type="video/mp4" />
											</video>
											<div class="card-overlay">
												<span class="card-category">{item.data.category}</span>
												<h3 class="card-title">{item.data.title}</h3>
											</div>
										</div>
									) : (
										<div class="card-image" style={`background-image: url('${item.data.image}')`}>
											<div class="card-overlay">
												<span class="card-category">{item.data.category}</span>
												<h3 class="card-title">{item.data.title}</h3>
											</div>
										</div>
									)}
								</div>
								<div class="flip-card-back">
									<div class="back-content">
										<span class="card-category">{item.data.category}</span>
										<h3>{item.data.title}</h3>
										<p>{item.data.description}</p>
										<div class="card-tags">
											{item.data.tags.map(tag => (
												<span class="tag">{tag}</span>
											))}
										</div>
										<span class="view-project">View Project &rarr;</span>
									</div>
								</div>
							</div>
						</a>
					))}
				</div>
				<p class="no-results" style="display: none; text-align: center; padding: 2rem; color: var(--color-medium);">No projects match this filter. <a href="/portfolio">View all work</a></p>
			</div>
		</section>

		<!-- CTA Section -->
		<section class="portfolio-cta bg-dark bg-pattern">
			<div class="container">
				<h2>Interested in working together?</h2>
				<p>I'm always open to discussing new projects and opportunities.</p>
				<a href="/contact" class="btn">Get in Touch</a>
			</div>
		</section>

		<Footer />
	</body>
</html>

<style>
	/* Filter Section */
	.filter-section {
		padding: 1.5rem 0 0 0;
	}

	.filter-section .container {
		max-width: 1200px;
		padding: 0 2rem;
	}

	.filter-bar {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem;
		justify-content: center;
	}

	.filter-btn {
		padding: 0.5rem 1.25rem;
		font-size: 0.85rem;
		font-family: var(--font-body);
		background: transparent;
		border: 1px solid var(--color-medium);
		color: var(--color-dark);
		border-radius: 25px;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.filter-btn:hover {
		background: var(--color-medium);
		color: var(--color-cream);
		border-color: var(--color-medium);
	}

	.filter-btn.active {
		background: var(--color-dark);
		color: var(--color-cream);
		border-color: var(--color-dark);
	}

	/* Hero Section */
	.portfolio-hero {
		padding-top: 5rem;
		padding-bottom: 2.5rem;
		text-align: center;
	}

	.portfolio-hero .container {
		max-width: 800px;
		padding: 0 2rem;
	}

	.portfolio-hero h1 {
		font-size: clamp(2rem, 4vw, 3rem);
		margin-bottom: 1rem;
	}

	.hero-intro {
		font-size: clamp(0.9rem, 1.1vw, 1.05rem);
		line-height: 1.8;
		opacity: 0.95;
	}

	/* Portfolio Section */
	.portfolio-section {
		padding: 3rem 0;
	}

	.portfolio-section .container {
		max-width: 1200px;
		padding: 0 2rem;
	}

	/* Portfolio Grid - Dynamic Masonry-like Layout */
	.portfolio-grid {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 1.5rem;
		grid-auto-flow: dense;
	}

	/* Flip Card Base */
	.flip-card {
		perspective: 1000px;
		height: 280px;
		animation: fadeInUp 0.6s ease forwards;
		animation-delay: var(--delay);
		opacity: 0;
		text-decoration: none;
		display: block;
		cursor: pointer;
	}

	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* Card Sizes for Visual Interest */
	.flip-card.large {
		grid-column: span 2;
		grid-row: span 2;
		height: 100%;
		min-height: 580px;
	}

	.flip-card.medium {
		grid-column: span 2;
		height: 280px;
	}

	.flip-card.small {
		grid-column: span 1;
		height: 280px;
	}

	/* Flip Card Inner */
	.flip-card-inner {
		position: relative;
		width: 100%;
		height: 100%;
		transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
		transform-style: preserve-3d;
	}

	.flip-card:hover .flip-card-inner {
		transform: rotateY(180deg);
	}

	/* Card Faces */
	.flip-card-front,
	.flip-card-back {
		position: absolute;
		width: 100%;
		height: 100%;
		backface-visibility: hidden;
		border-radius: 12px;
		overflow: hidden;
	}

	/* Front of Card */
	.flip-card-front {
		background: var(--color-dark);
	}

	.card-image {
		width: 100%;
		height: 100%;
		background-size: cover;
		background-position: center;
		background-color: var(--color-medium);
		position: relative;
	}

	.card-video {
		width: 100%;
		height: 100%;
		position: relative;
		overflow: hidden;
		background-color: var(--color-dark);
	}

	.card-video video {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.card-overlay {
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		padding: 1.5rem;
		background: linear-gradient(to top, rgba(61, 74, 42, 0.95) 0%, rgba(61, 74, 42, 0.7) 50%, transparent 100%);
		display: flex;
		flex-direction: column;
		justify-content: flex-end;
		min-height: 50%;
	}

	.card-category {
		font-size: 0.7rem;
		text-transform: uppercase;
		letter-spacing: 0.1em;
		color: var(--color-gold);
		margin-bottom: 0.5rem;
		font-weight: 600;
	}

	.card-title {
		font-size: clamp(1rem, 1.3vw, 1.2rem);
		color: var(--color-cream);
		line-height: 1.3;
		margin: 0;
	}

	.flip-card.large .card-title {
		font-size: clamp(1.2rem, 1.6vw, 1.5rem);
	}

	/* Back of Card */
	.flip-card-back {
		background: var(--color-dark);
		transform: rotateY(180deg);
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.back-content {
		padding: 1.5rem;
		text-align: center;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100%;
		justify-content: center;
	}

	.flip-card.large .back-content {
		padding: 2.5rem;
	}

	.back-content .card-category {
		margin-bottom: 0.75rem;
	}

	.back-content h3 {
		font-size: clamp(1rem, 1.2vw, 1.15rem);
		color: var(--color-cream);
		margin-bottom: 1rem;
		line-height: 1.3;
	}

	.flip-card.large .back-content h3 {
		font-size: clamp(1.2rem, 1.5vw, 1.4rem);
		margin-bottom: 1.25rem;
	}

	.back-content p {
		font-size: 0.85rem;
		color: var(--color-cream);
		line-height: 1.7;
		opacity: 0.9;
		margin-bottom: 1rem;
	}

	.flip-card.large .back-content p {
		font-size: 0.95rem;
	}

	.card-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		justify-content: center;
		margin-bottom: 1rem;
	}

	.tag {
		font-size: 0.7rem;
		padding: 0.25rem 0.6rem;
		background: rgba(107, 124, 76, 0.3);
		color: var(--color-gold);
		border-radius: 20px;
		border: 1px solid rgba(212, 201, 142, 0.2);
	}

	.view-project {
		font-size: 0.8rem;
		color: var(--color-gold);
		font-weight: 600;
		margin-top: auto;
		padding-top: 0.5rem;
		transition: transform 0.3s ease;
	}

	.flip-card:hover .view-project {
		transform: translateX(4px);
	}

	/* CTA Section */
	.portfolio-cta {
		padding: 3rem 0;
		text-align: center;
	}

	.portfolio-cta .container {
		max-width: 600px;
		padding: 0 2rem;
	}

	.portfolio-cta h2 {
		font-size: clamp(1.5rem, 2.5vw, 2rem);
		margin-bottom: 0.75rem;
	}

	.portfolio-cta p {
		font-size: clamp(0.9rem, 1vw, 1rem);
		margin-bottom: 1.5rem;
		opacity: 0.9;
	}

	/* Responsive */
	@media (max-width: 1024px) {
		.portfolio-grid {
			grid-template-columns: repeat(2, 1fr);
		}

		.flip-card.large {
			min-height: 500px;
		}
	}

	@media (max-width: 768px) {
		.portfolio-hero {
			padding-top: 4rem;
		}

		.portfolio-grid {
			grid-template-columns: 1fr;
			gap: 1.25rem;
		}

		.flip-card,
		.flip-card.large,
		.flip-card.medium,
		.flip-card.small {
			grid-column: span 1;
			height: 300px;
			min-height: 300px;
		}

		.flip-card.large {
			height: 350px;
			min-height: 350px;
		}

		/* Touch-friendly: tap to flip on mobile */
		.flip-card-inner {
			transition: transform 0.5s ease;
		}
	}

	@media (max-width: 480px) {
		.back-content {
			padding: 1.25rem;
		}

		.back-content p {
			font-size: 0.8rem;
		}
	}
</style>

<script>
	// Filter functionality
	const filterBtns = document.querySelectorAll('.filter-btn');
	const flipCards = document.querySelectorAll('.flip-card');
	const noResults = document.querySelector('.no-results');

	function filterCards(filter) {
		let visibleCount = 0;

		flipCards.forEach(card => {
			const tags = card.dataset.tags || '';
			const category = card.dataset.category || '';

			if (filter === 'all') {
				card.style.display = 'block';
				visibleCount++;
			} else if (tags.includes(filter) || category.includes(filter)) {
				card.style.display = 'block';
				visibleCount++;
			} else {
				card.style.display = 'none';
			}
		});

		// Show/hide no results message
		if (noResults) {
			noResults.style.display = visibleCount === 0 ? 'block' : 'none';
		}
	}

	function setActiveFilter(filter) {
		filterBtns.forEach(btn => {
			if (btn.dataset.filter === filter) {
				btn.classList.add('active');
			} else {
				btn.classList.remove('active');
			}
		});
	}

	// Handle filter button clicks
	filterBtns.forEach(btn => {
		btn.addEventListener('click', () => {
			const filter = btn.dataset.filter;
			setActiveFilter(filter);
			filterCards(filter);
			// Update URL hash
			if (filter === 'all') {
				history.pushState(null, '', window.location.pathname);
			} else {
				history.pushState(null, '', `#${filter}`);
			}
		});
	});

	// Check for hash on page load
	function checkHash() {
		const hash = window.location.hash.slice(1);
		if (hash && hash !== 'all') {
			setActiveFilter(hash);
			filterCards(hash);
		}
	}

	// Run on page load
	checkHash();

	// Handle back/forward navigation
	window.addEventListener('hashchange', checkHash);

	// Touch support for mobile - tap to flip, second tap to navigate
	if ('ontouchstart' in window) {
		document.querySelectorAll('.flip-card').forEach(card => {
			let flipped = false;
			card.addEventListener('click', function(e) {
				if (!flipped) {
					e.preventDefault();
					this.classList.add('flipped');
					flipped = true;
				}
				// Second tap will follow the link naturally
			});
		});
	}
</script>

<style>
	/* Mobile tap-to-flip support */
	@media (max-width: 768px) {
		.flip-card.flipped .flip-card-inner {
			transform: rotateY(180deg);
		}
	}
</style>
